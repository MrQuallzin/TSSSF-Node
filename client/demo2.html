<!DOCTYPE html>
<html>
  <head>
    <script>
      handlers = {}

      function getUserInput(prompt,type){
        return new Promise(function(good,bad){
          var modal = document.createElement("form"),
              input = document.createElement("input");
          input.type = type;
          input.placeholder = prompt;
          modal.onsubmit = function(){
            good(input.value);
            document.body.removeChild(modal);
            return false;
          }
          modal.appendChild(input);
          document.body.appendChild(modal);
          input.focus();
        })
      }

      function getUserSelection(prompt,options){
        return new Promise(function(good,bad){
          var modal = document.createElement("form"),
              submit = function(val){
                good(val);
                document.body.removeChild(modal);
                return false;
              };
          modal.textContent = prompt;
          options.forEach(function(n){
            var selection = document.createElement("button");
            selection.textContent = n.text;
            selection.onclick = submit.bind(null,n.value);
            modal.appendChild(selection);
          });
          document.body.appendChild(modal);
        });
      }

      handlers.getName = function(data){
        getUserInput(data.msg).then(function(name){
          ws.send({type:"name",name:name});
        })
      }

      handlers.rooms = function(data){
        var rooms = data.rooms.map(n => ({text:n.name,value:n.id}));
        rooms.push({text:"New game",value:"+NEW"});
        getUserSelection("Select Game to join:",rooms).then(function(room){
          ws.send({type:"join",room:room});
        })
      }

      var ws = new WebSocket("ws://" + location.host);
      ws.onmessage = function(msg){
        var data = JSON.parse(msg.data),
            handler = handlers[data.type];
        if(handler === undefined){
          console.warn("No handler for ",data.type,data);
        } else {
          console.log(data);
          handlers[data.type](data);
        }
      };
      ws._send = ws.send;
      ws.send = function(data){
        ws._send(JSON.stringify(data));
      }

    </script>
  </head>
  <body>

  </body>
</html>
